<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>å°å­¸è¨˜æ†¶å¡ Anki Kids</title>
    <!-- React æ ¸å¿ƒ -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel ç”¨æ–¼è§£æ JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS ç”¨æ–¼æ¨£å¼ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase (è«‹å…ˆåœ¨ä¸‹æ–¹å¡«å…¥ä½ çš„å°ˆæ¡ˆè¨­å®š) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <style>
        html, body {
            touch-action: manipulation;
            font-family: "Noto Sans TC", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f9ff;
            overscroll-behavior-y: none;
            height: 100%;
            margin: 0;
        }
        .card-flip {
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        @keyframes fade-in-up {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-up {
            animation: fade-in-up 0.3s ease-out forwards;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Firebase è¨­å®šï¼ˆè«‹åˆ° Firebase Console ç”¢ç”Ÿè¨­å®šå¾Œï¼Œè²¼åˆ°é€™è£¡ï¼‰ ---
        const FIREBASE_CONFIG = {
			apiKey: "AIzaSyC3TBtkq_Q9jYSpcL_ZG091TtM2VynHmTM",
			authDomain: "anki-kids.firebaseapp.com",
			projectId: "anki-kids",
			storageBucket: "anki-kids.firebasestorage.app",
			messagingSenderId: "487633112892",
			appId: "1:487633112892:web:8fb631f5061ff1d3bf5839"
        };

        let firebaseApp = null;
        let db = null;

        function initFirebase() {
            if (!window.firebase) {
                console.warn("Firebase SDK å°šæœªè¼‰å…¥");
                return null;
            }
            if (!firebase.apps.length) {
                firebaseApp = firebase.initializeApp(FIREBASE_CONFIG);
            } else {
                firebaseApp = firebase.app();
            }
            db = firebase.firestore();
            return db;
        }

        function getUserIdFromLocal() {
            let id = localStorage.getItem('anki-kids-user-id');
            if (!id) {
                id = window.prompt('è«‹è¼¸å…¥å°æœ‹å‹åç¨±æˆ–å¸³è™Ÿï¼Œç”¨ä¾†åŒæ­¥è³‡æ–™ï¼š', 'leo') || 'guest';
                localStorage.setItem('anki-kids-user-id', id);
            }
            return id;
        }

        // --- å…§å»ºåœ–ç¤ºå…ƒä»¶ ---
        const Icons = {
            BookOpen: (props) => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
            ),
            ChevronLeft: (props) => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m15 18-6-6 6-6"/></svg>
            ),
            Home: (props) => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
            ),
            Trophy: (props) => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>
            ),
            Settings: (props) => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.35a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
            ),
            Trash2: (props) => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
            ),
            Upload: (props) => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>
            )
        };

        // --- åˆå§‹è³‡æ–™åº« ---
        const INITIAL_DATA = [
            // --- åœ‹èª ---
            { id: 'm1-1', subject: 'mandarin', grade: 1, front: 'å¤©', back: 'ã„Šã„§ã„¢', context: 'ä»Šå¤©å¤©æ°£å¾ˆå¥½ã€‚', level: 'new' },
            { id: 'm1-2', subject: 'mandarin', grade: 1, front: 'å¤§', back: 'ã„‰ã„šË‹', context: 'é€™é¡†è˜‹æœå¾ˆå¤§ã€‚', level: 'new' },
            { id: 'm1-3', subject: 'mandarin', grade: 1, front: 'æ‰‹', back: 'ã„•ã„¡Ë‡', context: 'è«‹æŠŠæ‰‹æ´—ä¹¾æ·¨ã€‚', level: 'new' },
            { id: 'm2-1', subject: 'mandarin', grade: 2, front: 'æµ·', back: 'ã„ã„Ë‡', context: 'æˆ‘æƒ³å»æµ·é‚Šç©æ°´ã€‚', level: 'new' },
            // --- è‹±æ–‡ ---
            { id: 'e1-1', subject: 'english', grade: 1, front: 'Apple', back: 'è˜‹æœ', context: 'I like to eat apples.', level: 'new' },
            { id: 'e1-2', subject: 'english', grade: 1, front: 'Red', back: 'ç´…è‰²', context: 'The car is red.', level: 'new' },
            { id: 'e1-3', subject: 'english', grade: 1, front: 'Cat', back: 'è²“', context: 'The cat is sleeping.', level: 'new' },
        ];

        // --- Helper Functions ---
        const loadData = () => {
            try {
                const saved = localStorage.getItem('anki-kids-data-v1');
                if (saved) return JSON.parse(saved);
            } catch (e) { console.error("è®€å–å¤±æ•—", e); }
            return INITIAL_DATA.map(card => ({ ...card, interval: 0, reps: 0, ease: 2.5, dueDate: Date.now() }));
        };

        const saveData = (data) => {
            try { localStorage.setItem('anki-kids-data-v1', JSON.stringify(data)); } catch (e) { console.error("å„²å­˜å¤±æ•—", e); }
        };

        // --- ä¸»ç¨‹å¼ App ---
        function App() {
            const [allCards, setAllCards] = useState(loadData);
            const [userId, setUserId] = useState(null);
            const [isCloudReady, setIsCloudReady] = useState(false);
            const [view, setView] = useState('home'); // home, study, finish, settings
            const [cloudStatus, setCloudStatus] = useState('idle'); // idle | loading | ok | error
            const [cloudMessage, setCloudMessage] = useState('');
            const [selectedDeck, setSelectedDeck] = useState(null); 
            const [studyQueue, setStudyQueue] = useState([]);
            const [currentCardIndex, setCurrentCardIndex] = useState(0);
            const [isFlipped, setIsFlipped] = useState(false);
            const [fontSize, setFontSize] = useState(1.5);
            const fileInputRef = useRef(null);

            // è¨­å®šé é¢ç‹€æ…‹
            const [settingsSubject, setSettingsSubject] = useState('mandarin');
            const [settingsGrade, setSettingsGrade] = useState(1);

            useEffect(() => { saveData(allCards); }, [allCards]);

            // æ¯æ¬¡å¡ç‰‡è³‡æ–™è®Šæ›´æ™‚ï¼ŒåŒæ­¥åˆ° Firebase Firestoreï¼ˆå‚™ä»½ + å¤šè£ç½®åŒæ­¥ï¼‰
            useEffect(() => {
                // å°šæœªå®Œæˆé›²ç«¯åˆå§‹åŒ–ï¼ˆé‚„åœ¨æ±ºå®šè¦ç”¨ã€Œé›²ç«¯ç‰ˆæœ¬ã€é‚„æ˜¯ã€Œæœ¬æ©Ÿç‰ˆæœ¬ã€ï¼‰æ™‚ï¼Œä¸è¦å¯«å…¥ï¼Œé¿å…ä¸åŒè£ç½®äº’ç›¸è¦†è“‹ã€‚
                if (!db || !userId || !isCloudReady) return;
                try {
                    console.log('[SYNC] å¯«å…¥é›²ç«¯ userId=', userId, 'cards=', allCards.length);
                    setCloudStatus('loading');
                    db.collection('ankiKidsUsers')
                        .doc(userId)
                        .set({ cards: allCards }, { merge: true })
                        .then(() => {
                            setCloudStatus('ok');
                            setCloudMessage('å·²åŒæ­¥åˆ°é›²ç«¯ ' + new Date().toLocaleString());
                        })
                        .catch((e) => {
                            console.error("å„²å­˜åˆ°é›²ç«¯å¤±æ•—", e);
                            setCloudStatus('error');
                            setCloudMessage('å„²å­˜åˆ°é›²ç«¯å¤±æ•—');
                        });
                } catch (e) {
                    console.error('[SYNC] ä¾‹å¤–éŒ¯èª¤', e);
                }
            }, [allCards, userId, isCloudReady]);

            // å•Ÿå‹•æ™‚ï¼šåˆå§‹åŒ– Firebaseã€å–å¾—ä½¿ç”¨è€… IDï¼Œå¾é›²ç«¯è¼‰å…¥è³‡æ–™
            useEffect(() => {
                const init = async () => {
                    console.log('[INIT] å•Ÿå‹•ï¼Œå¾é›²ç«¯è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™');
                    const id = getUserIdFromLocal();
                    setUserId(id);
                    const _db = initFirebase();
                    if (!_db) {
                        setCloudStatus('error');
                        setCloudMessage('ç„¡æ³•åˆå§‹åŒ– Firebaseï¼Œè«‹æª¢æŸ¥è¨­å®š');
                        return;
                    }
                    setCloudStatus('loading');
                    try {
                        const docRef = _db.collection('ankiKidsUsers').doc(id);
                        console.log('[INIT] è®€å–é›²ç«¯æ–‡ä»¶è·¯å¾‘ ankiKidsUsers/', id);
                        const snap = await docRef.get();
                        const data = snap.data();
                        if (snap.exists && data && Array.isArray(data.cards)) {
                            console.log('[INIT] é›²ç«¯å·²æœ‰è³‡æ–™ï¼Œå¡ç‰‡æ•¸ =', data.cards.length, 'ï¼Œä»¥é›²ç«¯ç‚ºä¸»è¦†è“‹æœ¬æ©Ÿ');
                            // ä»¥é›²ç«¯ç‚ºä¸»ï¼Œè¦†è“‹æœ¬åœ°è³‡æ–™
                            setAllCards(data.cards);
                        } else {
                            console.log('[INIT] é›²ç«¯å°šç„¡è³‡æ–™ï¼Œä½¿ç”¨æœ¬æ©Ÿ INITIAL / localStorage ç•¶ä½œåˆå§‹å€¼ä¸Šå‚³');
                            // å¦‚æœé›²ç«¯é‚„æ²’æœ‰è³‡æ–™ï¼Œå°±æŠŠç›®å‰æœ¬åœ°è³‡æ–™ä¸Šå‚³ç•¶ä½œåˆå§‹å€¼
                            const local = loadData();
                            await docRef.set({ cards: local }, { merge: true });
                        }
                        setIsCloudReady(true);
                        setCloudStatus('ok');
                        setCloudMessage('å·²å¾é›²ç«¯è¼‰å…¥ ' + new Date().toLocaleString());
                    } catch (e) {
                        console.error("å¾é›²ç«¯è¼‰å…¥å¤±æ•—", e);
                        setCloudStatus('error');
                        setCloudMessage('å¾é›²ç«¯è¼‰å…¥å¤±æ•—');
                    }
                };
                init();
            }, []);

            const getDueCount = (subject, grade) => {
                const now = Date.now();
                return allCards.filter(c => c.subject === subject && c.grade === grade && c.dueDate <= now).length;
            };

            const getTotalCount = (subject, grade) => {
                return allCards.filter(c => c.subject === subject && c.grade === grade).length;
            };

            // --- å­¸ç¿’é‚è¼¯ ---
            const startStudy = (subject, grade) => {
                const now = Date.now();
                const queue = allCards.filter(c => c.subject === subject && c.grade === grade && c.dueDate <= now);
                const shuffled = queue.sort(() => Math.random() - 0.5);

                if (shuffled.length === 0) {
                    setTimeout(() => alert("å¤ªæ£’äº†ï¼é€™å€‹ç§‘ç›®ç›®å‰æ²’æœ‰éœ€è¦è¤‡ç¿’çš„å¡ç‰‡ã€‚"), 100);
                    return;
                }
                setSelectedDeck({ subject, grade });
                setStudyQueue(shuffled);
                setCurrentCardIndex(0);
                setIsFlipped(false);
                setView('study');
            };

            const handleRate = (rating) => {
                const currentCard = studyQueue[currentCardIndex];
                let { interval, reps, ease } = currentCard;

                if (rating === 0) { 
                    reps = 0; interval = 0;
                } else {
                    if (rating === 1) { ease = Math.max(1.3, ease - 0.15); interval = interval === 0 ? 1 : interval * 1.2; }
                    else if (rating === 2) { interval = interval === 0 ? 1 : (reps === 1 ? 6 : interval * ease); }
                    else if (rating === 3) { ease += 0.15; interval = interval === 0 ? 4 : interval * ease * 1.3; }
                    reps += 1;
                }

                let newDueDate = Date.now();
                if (rating > 0) newDueDate = Date.now() + (Math.ceil(interval) * 24 * 60 * 60 * 1000);

                const updatedCard = { ...currentCard, interval, reps, ease, dueDate: newDueDate };
                const newAllCards = allCards.map(c => c.id === updatedCard.id ? updatedCard : c);
                setAllCards(newAllCards);

                if (rating === 0) {
                    setStudyQueue([...studyQueue, currentCard]); 
                    setIsFlipped(false);
                    setCurrentCardIndex(prev => prev + 1); 
                } else {
                    setIsFlipped(false);
                    if (currentCardIndex < studyQueue.length - 1) setCurrentCardIndex(prev => prev + 1);
                    else setView('finish');
                }
            };

            // --- è¨­å®šåŠŸèƒ½é‚è¼¯ ---
            const handleResetProgress = () => {
                const confirmReset = confirm(`ç¢ºå®šè¦æ¸…é™¤ã€Œ${settingsGrade}å¹´ç´š ${settingsSubject === 'mandarin' ? 'åœ‹èª' : 'è‹±æ–‡'}ã€çš„æ‰€æœ‰å­¸ç¿’è¨˜æ†¶å—ï¼Ÿ\n\né€™æœƒå°‡æ‰€æœ‰å¡ç‰‡è®Šå›ã€Œæ–°å¡ç‰‡ã€ã€‚`);
                if (!confirmReset) return;

                const newAllCards = allCards.map(card => {
                    if (card.subject === settingsSubject && card.grade === parseInt(settingsGrade)) {
                        return { ...card, interval: 0, reps: 0, ease: 2.5, dueDate: Date.now() };
                    }
                    return card;
                });
                setAllCards(newAllCards);
                alert("å­¸ç¿’è¨˜æ†¶å·²æ¸…é™¤ï¼");
            };

            const handleFileUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const text = e.target.result;
                        const lines = text.split('\n');
                        const newCards = [];
                        const timestamp = Date.now();

                        lines.forEach((line, index) => {
                            const parts = line.trim().split('|');
                            if (parts.length >= 2) {
                                newCards.push({
                                    id: `custom-${timestamp}-${index}`,
                                    subject: settingsSubject,
                                    grade: parseInt(settingsGrade),
                                    front: parts[0].trim(),
                                    back: parts[1].trim(),
                                    context: parts[2] ? parts[2].trim() : '',
                                    level: 'new',
                                    interval: 0, reps: 0, ease: 2.5, dueDate: Date.now()
                                });
                            }
                        });

                        if (newCards.length > 0) {
                            setAllCards(prev => [...prev, ...newCards]);
                            alert(`æˆåŠŸåŒ¯å…¥ ${newCards.length} å¼µå¡ç‰‡åˆ°ã€Œ${settingsGrade}å¹´ç´š ${settingsSubject === 'mandarin' ? 'åœ‹èª' : 'è‹±æ–‡'}ã€ï¼`);
                        } else {
                            alert("æª”æ¡ˆå…§å®¹æ ¼å¼ä¼¼ä¹ä¸æ­£ç¢ºï¼Œæ‰¾ä¸åˆ°å¯åŒ¯å…¥çš„å¡ç‰‡ã€‚\nè«‹ç¢ºèªä½¿ç”¨ã€Œ|ã€åˆ†éš”å…§å®¹ã€‚");
                        }
                    } catch (error) {
                        console.error(error);
                        alert("è®€å–æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚");
                    }
                    // é‡ç½® input è®“ä½¿ç”¨è€…å¯ä»¥é‡è¤‡ä¸Šå‚³åŒå€‹æª”æ¡ˆ
                    if (fileInputRef.current) fileInputRef.current.value = '';
                };
                reader.readAsText(file);
            };

            const handleBack = () => {
                if (view === 'study') {
                    const leave = window.confirm('è¦çµæŸé€™æ¬¡ç·´ç¿’ä¸¦å›åˆ°é¦–é å—ï¼Ÿ');
                    if (!leave) return;
                }
                setView('home');
                setSelectedDeck(null);
                setStudyQueue([]);
                setCurrentCardIndex(0);
                setIsFlipped(false);
            };

            const reloadFromCloud = async () => {
                if (!db || !userId) {
                    alert('é›²ç«¯å°šæœªæº–å‚™å¥½ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
                    return;
                }
                try {
                    setCloudStatus('loading');
                    setCloudMessage('æ­£åœ¨å¾é›²ç«¯é‡æ–°è¼‰å…¥...');
                    const docRef = db.collection('ankiKidsUsers').doc(userId);
                    const snap = await docRef.get();
                    const data = snap.data();
                    if (snap.exists && data && Array.isArray(data.cards)) {
                        setAllCards(data.cards);
                        setCloudStatus('ok');
                        setCloudMessage('å·²å¾é›²ç«¯é‡æ–°è¼‰å…¥ ' + new Date().toLocaleString());
                    } else {
                        setCloudStatus('error');
                        setCloudMessage('é›²ç«¯ç›®å‰æ²’æœ‰è³‡æ–™');
                    }
                } catch (e) {
                    console.error('é‡è¼‰é›²ç«¯å¤±æ•—', e);
                    setCloudStatus('error');
                    setCloudMessage('é‡è¼‰é›²ç«¯å¤±æ•—');
                }
            };

            const handleSwitchUser = async () => {
                const newId = window.prompt(
                    'è«‹è¼¸å…¥è¦åˆ‡æ›çš„å°æœ‹å‹åç¨±æˆ–å¸³è™Ÿï¼š',
                    userId || ''
                ) || '';

                const trimmed = newId.trim();
                if (!trimmed || trimmed === userId) return;

                // 1. æ›´æ–° localStorage ä¸­çš„ä½¿ç”¨è€… ID
                localStorage.setItem('anki-kids-user-id', trimmed);

                // 2. é‡è¨­ç‹€æ…‹ï¼Œæº–å‚™è¼‰å…¥æ–°ä½¿ç”¨è€…
                setUserId(trimmed);
                setIsCloudReady(false);
                setCloudStatus('loading');
                setCloudMessage('æ­£åœ¨åˆ‡æ›ä½¿ç”¨è€…ï¼Œå¾é›²ç«¯è¼‰å…¥...');

                try {
                    const _db = db || initFirebase();
                    if (!_db) {
                        setCloudStatus('error');
                        setCloudMessage('åˆ‡æ›å¤±æ•—ï¼šç„¡æ³•åˆå§‹åŒ– Firebase');
                        return;
                    }

                    const docRef = _db.collection('ankiKidsUsers').doc(trimmed);
                    const snap = await docRef.get();
                    const data = snap.data();

                    if (snap.exists && data && Array.isArray(data.cards)) {
                        console.log(
                            '[SWITCH] åˆ‡æ›åˆ°ä½¿ç”¨è€…',
                            trimmed,
                            'ï¼Œå¾é›²ç«¯è¼‰å…¥å¡ç‰‡æ•¸ =',
                            data.cards.length
                        );
                        // 3A. é›²ç«¯å·²æœ‰è³‡æ–™ï¼Œç›´æ¥ç”¨é›²ç«¯è¦†è“‹
                        setAllCards(data.cards);
                    } else {
                        console.log(
                            '[SWITCH] ä½¿ç”¨è€…',
                            trimmed,
                            'å°šç„¡é›²ç«¯è³‡æ–™ï¼Œä½¿ç”¨ INITIAL_DATA ç•¶ä½œåˆå§‹å€¼'
                        );
                        // 3B. æ–°ä½¿ç”¨è€…ï¼Œçµ¦ä¸€ä»½åˆå§‹è³‡æ–™
                        const fresh = INITIAL_DATA.map(card => ({
                            ...card,
                            interval: 0,
                            reps: 0,
                            ease: 2.5,
                            dueDate: Date.now()
                        }));
                        await docRef.set({ cards: fresh }, { merge: true });
                        setAllCards(fresh);
                    }

                    setIsCloudReady(true);
                    setCloudStatus('ok');
                    setCloudMessage(
                        'å·²åˆ‡æ›è‡³ä½¿ç”¨è€… ' + trimmed + 'ï¼Œä¸¦å¾é›²ç«¯è¼‰å…¥ ' + new Date().toLocaleString()
                    );
                } catch (e) {
                    console.error('[SWITCH] åˆ‡æ›ä½¿ç”¨è€…å¤±æ•—', e);
                    setCloudStatus('error');
                    setCloudMessage('åˆ‡æ›ä½¿ç”¨è€…å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                }
            };

            // --- è¦–åœ–çµ„ä»¶ ---
            const Header = () => {
                const dataSizeKB = Math.round(JSON.stringify(allCards).length / 1024);
                return (
                    <div className="bg-white shadow-sm p-4 flex justify-between items-center sticky top-0 z-10">
                        <div className="flex items-center gap-2">
                            {view !== 'home' ? (
                                <button
                                    onClick={handleBack}
                                    className="p-2 hover:bg-gray-100 rounded-full text-gray-700 flex items-center gap-1"
                                >
                                    <Icons.ChevronLeft className="w-5 h-5" />
                                    <span className="text-sm hidden sm:inline">è¿”å›</span>
                                </button>
                            ) : (
                                <button
                                    onClick={() => setView('settings')}
                                    className="p-2 hover:bg-gray-100 rounded-full text-gray-600 flex items-center gap-1"
                                >
                                    <Icons.Settings className="w-5 h-5" />
                                    <span className="text-sm hidden sm:inline">è¨­å®š/è³‡æ–™</span>
                                </button>
                            )}
                        </div>
                        <div className="flex items-center gap-3">
                            {userId && (
                                <div className="flex flex-col items-end mr-2">
                                    <span className="text-xs text-gray-500">ğŸ‘¤ {userId}</span>
                                    {cloudStatus === 'loading' && (
                                        <span className="text-[10px] text-blue-500">â˜ï¸ èˆ‡é›²ç«¯åŒæ­¥ä¸­â€¦</span>
                                    )}
                                    {cloudStatus === 'ok' && (
                                        <span className="text-[10px] text-green-600">â˜ï¸ é›²ç«¯å·²é€£ç·š</span>
                                    )}
                                    {cloudStatus === 'error' && (
                                        <span className="text-[10px] text-red-500">â˜ï¸ é›²ç«¯éŒ¯èª¤</span>
                                    )}
                                    {cloudMessage && (
                                        <span className="text-[10px] text-gray-400 mt-0.5">{cloudMessage}</span>
                                    )}
                                    <span className="text-[10px] text-gray-400 mt-0.5">
                                        å¡ç‰‡æ•¸ï¼š{allCards.length}ï¼Œç´„ {dataSizeKB} KB
                                    </span>
                                </div>
                            )}
                            <button
                                onClick={handleSwitchUser}
                                className="px-2 py-1 text-[10px] border rounded-md text-gray-600 hover:bg-gray-100"
                            >
                                åˆ‡æ›ä½¿ç”¨è€…
                            </button>
                            <button
                                onClick={reloadFromCloud}
                                className="px-2 py-1 text-[10px] border rounded-md text-gray-600 hover:bg-gray-100"
                            >
                                é‡æ–°è¼‰å…¥é›²ç«¯
                            </button>
                            <span className="text-sm text-gray-500 hidden sm:inline ml-2">å­—é«”:</span>
                            <input
                                type="range"
                                min="1"
                                max="3"
                                step="0.1"
                                value={fontSize}
                                onChange={(e) => setFontSize(parseFloat(e.target.value))}
                                className="w-20 accent-blue-500"
                            />
                        </div>
                    </div>
                );
            };

            const SettingsView = () => (
                <div className="p-4 max-w-2xl mx-auto animate-fade-in-up">
                    <h2 className="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                        <Icons.Settings className="w-8 h-8 text-blue-600" />
                        è¨­å®šèˆ‡è³‡æ–™ç®¡ç†
                    </h2>
                    
                    <div className="bg-white p-6 rounded-2xl shadow-sm border border-blue-100 mb-6">
                        <h3 className="font-bold text-lg mb-4 border-b pb-2">1. é¸æ“‡è¦ç®¡ç†çš„é¡åˆ¥</h3>
                        <div className="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label className="block text-sm text-gray-500 mb-1">ç§‘ç›®</label>
                                <select 
                                    value={settingsSubject} 
                                    onChange={(e) => setSettingsSubject(e.target.value)}
                                    className="w-full p-3 border rounded-xl bg-gray-50 text-lg font-medium"
                                >
                                    <option value="mandarin">ğŸ‡¹ğŸ‡¼ åœ‹èª</option>
                                    <option value="english">ğŸ‡ºğŸ‡¸ è‹±æ–‡</option>
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm text-gray-500 mb-1">å¹´ç´š</label>
                                <select 
                                    value={settingsGrade} 
                                    onChange={(e) => setSettingsGrade(e.target.value)}
                                    className="w-full p-3 border rounded-xl bg-gray-50 text-lg font-medium"
                                >
                                    {[1,2,3,4,5,6].map(g => <option key={g} value={g}>{g} å¹´ç´š</option>)}
                                </select>
                            </div>
                        </div>
                        <div className="text-sm text-gray-500 mb-2">
                            ç›®å‰æ­¤é¡åˆ¥å…±æœ‰ <span className="font-bold text-blue-600 text-lg">{getTotalCount(settingsSubject, parseInt(settingsGrade))}</span> å¼µå¡ç‰‡
                        </div>
                    </div>

                    <div className="bg-white p-6 rounded-2xl shadow-sm border border-red-100 mb-6">
                        <h3 className="font-bold text-lg text-red-600 mb-4 border-b pb-2 flex items-center gap-2">
                            <Icons.Trash2 className="w-5 h-5" />
                            2. æ¸…é™¤å­¸ç¿’è¨˜æ†¶
                        </h3>
                        <p className="text-gray-600 mb-4 text-sm">
                            å¦‚æœä½ è¦ºå¾—é€™å€‹åˆ†é¡çš„å¡ç‰‡å¤ªä¹…æ²’è¤‡ç¿’ï¼Œé€²åº¦äº‚æ‰äº†ï¼Œå¯ä»¥æŒ‰é€™å€‹æŒ‰éˆ•ã€‚
                            æ‰€æœ‰å¡ç‰‡æœƒè®Šæˆã€Œæ–°å¡ç‰‡ã€ï¼Œä½ å¯ä»¥é‡æ–°é–‹å§‹å­¸ç¿’ã€‚
                        </p>
                        <button 
                            onClick={handleResetProgress}
                            className="w-full py-3 rounded-xl border-2 border-red-400 text-red-600 font-bold hover:bg-red-50 active:bg-red-100 transition-colors"
                        >
                            æ¸…é™¤æ­¤é¡åˆ¥çš„å­¸ç¿’é€²åº¦
                        </button>
                    </div>

                    <div className="bg-white p-6 rounded-2xl shadow-sm border border-green-100 mb-6">
                        <h3 className="font-bold text-lg text-green-700 mb-4 border-b pb-2 flex items-center gap-2">
                            <Icons.Upload className="w-5 h-5" />
                            3. åŒ¯å…¥è‡ªè¨‚è³‡æ–™
                        </h3>
                        <p className="text-gray-600 mb-4 text-sm">
                            è«‹ä¸Šå‚³ <b>.txt</b> æ–‡å­—æª”ã€‚æ¯ä¸€è¡Œä»£è¡¨ä¸€å¼µå¡ç‰‡ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š<br/>
                            <code className="bg-gray-100 px-2 py-1 rounded text-gray-800 block mt-2">æ­£é¢(é¡Œç›®) | èƒŒé¢(ç­”æ¡ˆ) | ä¾‹å¥(é¸å¡«)</code>
                            <span className="text-xs text-gray-400 mt-1 block">ä¾‹å¦‚ï¼šApple | è˜‹æœ | I eat an apple.</span>
                        </p>
                        <label className="flex flex-col items-center justify-center w-full h-32 border-2 border-green-300 border-dashed rounded-xl cursor-pointer bg-green-50 hover:bg-green-100 transition-colors">
                            <div className="flex flex-col items-center justify-center pt-5 pb-6">
                                <Icons.Upload className="w-8 h-8 text-green-500 mb-2" />
                                <p className="mb-2 text-sm text-green-700"><span className="font-semibold">é»æ“Šä¸Šå‚³ TXT æª”æ¡ˆ</span></p>
                            </div>
                            <input ref={fileInputRef} type="file" className="hidden" accept=".txt" onChange={handleFileUpload} />
                        </label>
                    </div>
                </div>
            );

            const HomeView = () => (
                <div className="p-4 max-w-4xl mx-auto pb-20">
                    <div className="mb-8 bg-blue-100 p-6 rounded-2xl border-2 border-blue-200 text-center">
                        <h2 className="text-2xl font-bold text-blue-800 mb-2">æ­¡è¿å›ä¾†ï¼</h2>
                        <p className="text-blue-600">ä»Šå¤©æœ‰ <span className="font-bold text-red-500 text-xl">{allCards.filter(c => c.dueDate <= Date.now()).length}</span> å¼µå¡ç‰‡éœ€è¦è¤‡ç¿’å–”ã€‚</p>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                        {/* åœ‹èªå€å¡Š */}
                        <div className="bg-white rounded-2xl shadow-md overflow-hidden border-2 border-orange-100">
                            <div className="bg-orange-100 p-3 font-bold text-orange-800 flex items-center gap-2">
                                <span className="text-2xl">ğŸ‡¹ğŸ‡¼</span> åœ‹èª
                            </div>
                            <div className="p-4 grid grid-cols-3 gap-3">
                                {[1, 2, 3, 4, 5, 6].map(grade => {
                                    const count = getDueCount('mandarin', grade);
                                    return (
                                        <button key={grade} onClick={() => startStudy('mandarin', grade)} className={`aspect-square rounded-xl flex flex-col items-center justify-center border-2 transition-all active:scale-95 ${count > 0 ? 'bg-orange-50 border-orange-200 hover:bg-orange-100' : 'bg-gray-50 border-gray-100 text-gray-400'}`}>
                                            <span className="text-2xl font-bold">{grade}</span><span className="text-xs">å¹´ç´š</span>
                                            {count > 0 && <span className="mt-1 bg-red-500 text-white text-xs px-2 py-0.5 rounded-full">{count}</span>}
                                        </button>
                                    )
                                })}
                            </div>
                        </div>

                        {/* è‹±æ–‡å€å¡Š */}
                        <div className="bg-white rounded-2xl shadow-md overflow-hidden border-2 border-indigo-100">
                            <div className="bg-indigo-100 p-3 font-bold text-indigo-800 flex items-center gap-2">
                                <span className="text-2xl">ğŸ‡ºğŸ‡¸</span> English
                            </div>
                            <div className="p-4 grid grid-cols-3 gap-3">
                                {[1, 2, 3, 4, 5, 6].map(grade => {
                                    const count = getDueCount('english', grade);
                                    return (
                                        <button key={grade} onClick={() => startStudy('english', grade)} className={`aspect-square rounded-xl flex flex-col items-center justify-center border-2 transition-all active:scale-95 ${count > 0 ? 'bg-indigo-50 border-indigo-200 hover:bg-indigo-100' : 'bg-gray-50 border-gray-100 text-gray-400'}`}>
                                            <span className="text-2xl font-bold">{grade}</span><span className="text-xs">Grade</span>
                                            {count > 0 && <span className="mt-1 bg-red-500 text-white text-xs px-2 py-0.5 rounded-full">{count}</span>}
                                        </button>
                                    )
                                })}
                            </div>
                        </div>
                    </div>
                </div>
            );

            const StudyView = () => {
                const card = studyQueue[currentCardIndex];
                if (!card) return null;
                const progress = ((currentCardIndex) / studyQueue.length) * 100;

                return (
                    <div className="flex flex-col h-[calc(100vh-70px)] bg-gray-100">
                        <div className="h-2 bg-gray-200 w-full"><div className="h-full bg-green-500 transition-all duration-300" style={{ width: `${progress}%` }}></div></div>
                        <div className="flex-1 flex items-center justify-center p-4">
                            <div className="relative w-full max-w-xl aspect-[4/5] md:aspect-[16/9] perspective-1000">
                                <div className={`relative w-full h-full bg-white rounded-3xl shadow-xl flex flex-col items-center justify-center p-8 text-center border-2 border-gray-200 transition-all duration-300`}>
                                    <div className="mb-8">
                                        <span className="inline-block bg-gray-100 text-gray-500 px-3 py-1 rounded-full text-sm mb-4">{card.subject === 'mandarin' ? 'æ€éº¼å”¸ï¼Ÿ' : 'What is this?'}</span>
                                        <h2 className="font-bold text-gray-800" style={{ fontSize: `${fontSize * 2}rem` }}>{card.front}</h2>
                                    </div>
                                    {isFlipped && (
                                        <div className="animate-fade-in-up w-full pt-6 border-t-2 border-dashed border-gray-200">
                                            <div className="text-red-500 font-bold mb-2" style={{ fontSize: `${fontSize * 1.2}rem` }}>{card.back}</div>
                                            <div className="text-gray-600 bg-gray-50 p-4 rounded-xl" style={{ fontSize: `${fontSize}rem` }}>{card.context}</div>
                                        </div>
                                    )}
                                    {!isFlipped && <button onClick={() => setIsFlipped(true)} className="absolute inset-0 w-full h-full cursor-pointer opacity-0">Reveal</button>}
                                    {!isFlipped && <div className="absolute bottom-8 text-gray-400 text-sm animate-pulse pointer-events-none">é»æ“Šå¡ç‰‡çœ‹ç­”æ¡ˆ</div>}
                                </div>
                            </div>
                        </div>
                        <div className="h-auto bg-white border-t p-4 pb-8 md:pb-4 shadow-lg z-20">
                            {!isFlipped ? (
                                <button onClick={() => setIsFlipped(true)} className="w-full bg-blue-500 hover:bg-blue-600 text-white py-4 rounded-xl text-xl font-bold shadow-md transition-transform active:scale-95">é¡¯ç¤ºç­”æ¡ˆ</button>
                            ) : (
                                <div className="grid grid-cols-4 gap-2 md:gap-4">
                                    <button onClick={() => handleRate(0)} className="flex flex-col items-center bg-red-100 text-red-700 py-3 rounded-xl border border-red-200 active:bg-red-200"><span className="font-bold text-lg">Again</span><span className="text-xs opacity-70">å¿˜è¨˜äº†</span></button>
                                    <button onClick={() => handleRate(1)} className="flex flex-col items-center bg-yellow-100 text-yellow-700 py-3 rounded-xl border border-yellow-200 active:bg-yellow-200"><span className="font-bold text-lg">Hard</span><span className="text-xs opacity-70">æœ‰é»é›£</span></button>
                                    <button onClick={() => handleRate(2)} className="flex flex-col items-center bg-green-100 text-green-700 py-3 rounded-xl border border-green-200 active:bg-green-200"><span className="font-bold text-lg">Good</span><span className="text-xs opacity-70">å‰›å¥½</span></button>
                                    <button onClick={() => handleRate(3)} className="flex flex-col items-center bg-blue-100 text-blue-700 py-3 rounded-xl border border-blue-200 active:bg-blue-200"><span className="font-bold text-lg">Easy</span><span className="text-xs opacity-70">å¤ªç°¡å–®</span></button>
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            const FinishView = () => (
                <div className="flex flex-col items-center justify-center min-h-[80vh] p-4 text-center animate-fade-in">
                    <div className="bg-yellow-100 p-8 rounded-full mb-6"><Icons.Trophy className="w-24 h-24 text-yellow-600" /></div>
                    <h2 className="text-3xl font-bold text-gray-800 mb-4">æ­å–œå®Œæˆï¼</h2>
                    <p className="text-xl text-gray-600 mb-8">{selectedDeck.grade} å¹´ç´š {selectedDeck.subject === 'mandarin' ? 'åœ‹èª' : 'è‹±æ–‡'} è¤‡ç¿’å®Œç•¢ã€‚</p>
                    <div className="flex gap-4">
                        <button onClick={() => setView('home')} className="bg-blue-500 text-white px-8 py-3 rounded-xl font-bold shadow-lg hover:bg-blue-600 transition-all flex items-center gap-2"><Icons.Home className="w-5 h-5" /> å›é¦–é </button>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen bg-gray-50 text-gray-900">
                    <Header />
                    {view === 'home' && <HomeView />}
                    {view === 'settings' && <SettingsView />}
                    {view === 'study' && <StudyView />}
                    {view === 'finish' && <FinishView />}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
